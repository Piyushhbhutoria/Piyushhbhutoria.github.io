---
import App from "@/App";
import "@/index.css";
import type {
    AboutData,
    AchievementsData,
    CertificationsData,
    ContactData,
    EducationData,
    ExperienceData,
    HeroData,
    Project,
    ProjectsData,
    SkillsData,
} from "@/types";
import { getEntry } from "astro:content";
import { getImage } from "astro:assets";

// Import all project images
import honestBox from "@/assets/projects/honest-box.png";
import houseHelp from "@/assets/projects/house-help.png";
import samudai from "@/assets/projects/samudai.jpeg";
import supertokens from "@/assets/projects/supertokens.png";
import whatsappWebApi from "@/assets/projects/whatsapp-web-api.png";
import wishWall from "@/assets/projects/wish-wall.png";
import pdfTool from "@/assets/projects/pdf-tool.png";
import retroBoard from "@/assets/projects/retro-board.png";

const heroEntry = await getEntry("site", "hero");
const heroData = heroEntry.data as unknown as HeroData;
const aboutEntry = await getEntry("site", "about");
const aboutData = aboutEntry.data as unknown as AboutData;
const experienceEntry = await getEntry("site", "experience");
const experienceData = experienceEntry.data as unknown as ExperienceData;
const projectsEntry = await getEntry("site", "projects");
const projectsRawData = projectsEntry.data as unknown as ProjectsData;

// Map filenames to imported images
const imageMap: Record<string, any> = {
    "honest-box.png": honestBox,
    "house-help.png": houseHelp,
    "samudai.jpeg": samudai,
    "supertokens.png": supertokens,
    "whatsapp-web-api.png": whatsappWebApi,
    "wish-wall.png": wishWall,
    "pdf-tool.png": pdfTool,
    "retro-board.png": retroBoard,
};

// Optimize images and get URLs
const optimizedImages: Record<string, string> = {};
for (const [filename, image] of Object.entries(imageMap)) {
    const optimized = await getImage({
        src: image,
        width: 800,
        height: 400,
        format: "webp",
    });
    optimizedImages[filename] = optimized.src;
}

const projectsData: ProjectsData = {
    ...projectsRawData,
    projects: projectsRawData.projects.map((project) => ({
        ...project,
        imageUrl: project.file ? optimizedImages[project.file] : undefined,
    })) as Project[],
};
const skillsEntry = await getEntry("site", "skills");
const skillsData = skillsEntry.data as unknown as SkillsData;
const certificationsEntry = await getEntry("site", "certifications");
const certificationsData =
    certificationsEntry.data as unknown as CertificationsData;
const achievementsEntry = await getEntry("site", "achievements");
const achievementsData = achievementsEntry.data as unknown as AchievementsData;
const educationEntry = await getEntry("site", "education");
const educationData = educationEntry.data as unknown as EducationData;
const contactEntry = await getEntry("site", "contact");
const contactData = contactEntry.data as unknown as ContactData;

// SEO Configuration
const siteUrl = "https://piyushhbhutoria.github.io";
const seoData = {
    title: `${heroData.name} - ${heroData.title}`,
    description: heroData.description,
    image: `${siteUrl}/og-image.jpg`,
    url: siteUrl,
    type: "website",
    twitterHandle: "@piyushhb",
};
---

<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />

        <!-- Primary Meta Tags -->
        <title>{seoData.title}</title>
        <meta name="title" content={seoData.title} />
        <meta name="description" content={seoData.description} />
        <meta name="author" content={heroData.name} />
        <meta
            name="keywords"
            content="Piyushh Bhutoria, Engineer, Consultant, Agency, Digitalisation, Ruby on Rails, Golang, Backend Engineer, Cloud Architecture, Microservices, Apps, Websites"
        />

        <!-- Open Graph / Facebook -->
        <meta property="og:type" content={seoData.type} />
        <meta property="og:url" content={seoData.url} />
        <meta property="og:title" content={seoData.title} />
        <meta property="og:description" content={seoData.description} />
        <meta property="og:image" content={seoData.image} />
        <meta property="og:site_name" content={heroData.name} />

        <!-- Twitter Card -->
        <meta name="twitter:card" content="summary_large_image" />
        <meta name="twitter:url" content={seoData.url} />
        <meta name="twitter:title" content={seoData.title} />
        <meta name="twitter:description" content={seoData.description} />
        <meta name="twitter:image" content={seoData.image} />
        <meta name="twitter:creator" content={seoData.twitterHandle} />

        <!-- Canonical URL -->
        <link rel="canonical" href={seoData.url} />

        <!-- Additional Meta Tags -->
        <meta name="robots" content="index, follow" />
        <meta name="language" content="English" />
        <meta name="revisit-after" content="7 days" />

        <!-- Critical CSS for above-the-fold content -->
        <style is:inline>
            /* Critical CSS - Hero Section & Header */
            body {
                margin: 0;
                font-family: "Space Grotesk", system-ui, sans-serif;
            }
            .brutal-border {
                border: 4px solid hsl(var(--border));
            }
            .brutal-shadow {
                box-shadow: 6px 6px 0px 0px hsl(var(--border));
            }
        </style>

        <!-- Structured Data (JSON-LD) -->
        <script
            type="application/ld+json"
            set:html={JSON.stringify({
                "@context": "https://schema.org",
                "@type": "Person",
                name: heroData.name,
                jobTitle: heroData.title,
                url: siteUrl,
                sameAs: [
                    heroData.social.github,
                    heroData.social.linkedin,
                    heroData.social.medium,
                ],
                knowsAbout: skillsData.skillCategories.flatMap(
                    (category: { items: string[] }) => category.items,
                ),
                email: heroData.social.email.replace("mailto:", ""),
                description: heroData.description,
            })}
        />

        <!-- Google Analytics -->
        <script
            async
            src={`https://www.googletagmanager.com/gtag/js?id=G-0QFYWC0TK8`}
        ></script>
        <script
            is:inline
            set:html={`window.dataLayer = window.dataLayer || [];
                        function gtag(){dataLayer.push(arguments);}
                        gtag('js', new Date());
                        gtag('config', 'G-0QFYWC0TK8', {
                            page_path: window.location.pathname,
                        });
                    `}
        />

        <!-- Core Web Vitals Monitoring -->
        <script>
            import("web-vitals").then(
                ({ onCLS, onFCP, onLCP, onTTFB, onINP }) => {
                    function sendToAnalytics({ name, delta, id, value }) {
                        console.log("Web Vital:", {
                            name,
                            delta,
                            id,
                            value,
                        });
                        if (
                            typeof window !== "undefined" &&
                            typeof (window as any).gtag !== "undefined"
                        ) {
                            (window as any).gtag("event", name, {
                                value: Math.round(
                                    name === "CLS" ? delta * 1000 : delta,
                                ),
                                event_label: id,
                                non_interaction: true,
                            });
                        }
                    }

                    onCLS(sendToAnalytics);
                    onINP(sendToAnalytics);
                    onFCP(sendToAnalytics);
                    onLCP(sendToAnalytics);
                    onTTFB(sendToAnalytics);
                },
            );
        </script>

        <script
            is:inline
            async
            src="https://www.noupe.com/embed/0198411c6cdb7a0c91e7e4006826dd6241a6.js"
        ></script>
    </head>
    <body>
        <App
            client:load
            heroData={heroData}
            aboutData={aboutData}
            experienceData={experienceData}
            projectsData={projectsData}
            skillsData={skillsData}
            certificationsData={certificationsData}
            achievementsData={achievementsData}
            educationData={educationData}
            contactData={contactData}
        />
    </body>
</html>
