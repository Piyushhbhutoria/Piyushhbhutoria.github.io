---
import App from "@/App";
import "@/index.css";
import type {
    AboutData,
    AchievementsData,
    CertificationsData,
    ContactData,
    EducationData,
    ExperienceData,
    HeroData,
    Project,
    ProjectsData,
    SkillsData,
} from "@/types";
import { getEntry } from "astro:content";

const projectImages = import.meta.glob("../content/projects/*.{png,jpeg,jpg}", {
    eager: true,
}) as Record<string, { default: { src: string } }>;

const heroEntry = await getEntry("site", "hero");
const heroData = heroEntry.data as unknown as HeroData;
const aboutEntry = await getEntry("site", "about");
const aboutData = aboutEntry.data as unknown as AboutData;
const experienceEntry = await getEntry("site", "experience");
const experienceData = experienceEntry.data as unknown as ExperienceData;
const projectsEntry = await getEntry("site", "projects");
const projectsRawData = projectsEntry.data as unknown as ProjectsData;

const getImageUrl = (filename: string): string | undefined => {
    const normalizedFilename = filename.toLowerCase();
    for (const [path, module] of Object.entries(projectImages)) {
        const pathFilename = path.split("/").pop()?.toLowerCase();
        if (pathFilename === normalizedFilename) {
            const img = module?.default;
            if (typeof img === "string") return img;
            if (img && typeof img === "object" && "src" in img) {
                return img.src as string;
            }
        }
    }
    return undefined;
};

const projectsData: ProjectsData = {
    ...projectsRawData,
    projects: projectsRawData.projects.map((project) => ({
        ...project,
        imageUrl: project.file ? getImageUrl(project.file) : undefined,
    })) as Project[],
};
const skillsEntry = await getEntry("site", "skills");
const skillsData = skillsEntry.data as unknown as SkillsData;
const certificationsEntry = await getEntry("site", "certifications");
const certificationsData =
    certificationsEntry.data as unknown as CertificationsData;
const achievementsEntry = await getEntry("site", "achievements");
const achievementsData = achievementsEntry.data as unknown as AchievementsData;
const educationEntry = await getEntry("site", "education");
const educationData = educationEntry.data as unknown as EducationData;
const contactEntry = await getEntry("site", "contact");
const contactData = contactEntry.data as unknown as ContactData;
---

<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Piyushh Bhutoria</title>
    </head>
    <body>
        <App
            client:load
            heroData={heroData}
            aboutData={aboutData}
            experienceData={experienceData}
            projectsData={projectsData}
            skillsData={skillsData}
            certificationsData={certificationsData}
            achievementsData={achievementsData}
            educationData={educationData}
            contactData={contactData}
        />
    </body>
</html>
